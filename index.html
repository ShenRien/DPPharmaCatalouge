<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>DP Pharma Catalogue</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            touch-action: pan-x;
        }

        body {
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            font-family: 'Helvetica Neue', sans-serif;
        }

        .header {
            background: white;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            text-align: center;
        }

        .title {
            color: #8B0000;
            font-size: 1.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin: 0;
        }

        #main-viewer {
            flex: 1;
            position: relative;
            max-width: 1200px;
            width: 95%;
            margin: 1rem auto;
        }

        .pdf-viewport {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 90vh;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .nav-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 45px;
            height: 70px;
            background: #8B0000DD;
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(2px);
            z-index: 100;
        }

        .nav-button:hover {
            background: #8B0000;
            width: 50px;
        }

        #prev-btn {
            left: -60px;
        }

        #next-btn {
            right: -60px;
        }

        .page-info {
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.1rem;
            color: #666;
            background: rgba(255,255,255,0.9);
            padding: 8px 20px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        #pdf-canvas {
            width: 100%;
            height: 100%;
            display: block;
            border-radius: 8px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8B0000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .nav-button {
                width: 35px;
                height: 50px;
                font-size: 1.2rem;
            }

            #prev-btn { left: -25px; }
            #next-btn { right: -25px; }

            .title {
                font-size: 1.4rem;
            }

            .pdf-viewport {
                height: 85vh;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="title">DP Pharma Catalogue</h1>
    </div>

    <div id="main-viewer">
        <button class="nav-button" id="prev-btn">‹</button>
        <div class="pdf-viewport">
            <canvas id="pdf-canvas"></canvas>
        </div>
        <button class="nav-button" id="next-btn">›</button>
        <div class="page-info">
            Trang <span id="current-page">1</span>/<span id="total-pages">0</span>
        </div>
    </div>

    <div class="loading-overlay" id="loader">
        <div class="spinner"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>
        let currentPage = 1;
        let pdfDoc = null;
        let isRendering = false;
        let pageCache = new Map();
        let devicePixelRatio = window.devicePixelRatio || 1;

        const config = {
            swipeThreshold: 50,
            preloadPages: 2,
            maxScale: 2.0,
            renderTimeout: 300,
            canvasPadding: 40
        };

        const showLoader = () => {
            document.getElementById('loader').style.opacity = '1';
        };

        const hideLoader = () => {
            document.getElementById('loader').style.opacity = '0';
        };

        const getOptimalScale = (viewport, containerWidth) => {
            const baseScale = Math.min(
                (containerWidth - config.canvasPadding) / viewport.width,
                config.maxScale
            );
            return Math.min(baseScale * devicePixelRatio, config.maxScale);
        };

        const renderPage = async (pageNum) => {
            if(isRendering) return;
            
            showLoader();
            isRendering = true;
            
            try {
                // Cache management
                if(!pageCache.has(pageNum)) {
                    pageCache.set(pageNum, await pdfDoc.getPage(pageNum));
                }
                
                const page = pageCache.get(pageNum);
                const viewport = page.getViewport({ scale: 1 });
                const canvas = document.getElementById('pdf-canvas');
                const context = canvas.getContext('2d');
                
                // Calculate dimensions
                const containerWidth = canvas.parentElement.clientWidth;
                const scale = getOptimalScale(viewport, containerWidth);
                const scaledViewport = page.getViewport({ scale });
                
                // Set canvas dimensions
                canvas.width = scaledViewport.width;
                canvas.height = scaledViewport.height;
                canvas.style.width = `${scaledViewport.width / devicePixelRatio}px`;
                canvas.style.height = `${scaledViewport.height / devicePixelRatio}px`;
                
                // Render with timeout
                await Promise.race([
                    page.render({
                        canvasContext: context,
                        viewport: scaledViewport
                    }).promise,
                    new Promise(resolve => setTimeout(resolve, config.renderTimeout))
                ]);

                // Preload adjacent pages
                for(let i = Math.max(1, pageNum - config.preloadPages); 
                    i <= Math.min(pdfDoc.numPages, pageNum + config.preloadPages); 
                    i++
                ) {
                    if(!pageCache.has(i)) {
                        pageCache.set(i, pdfDoc.getPage(i));
                    }
                }

                updateUI();

            } catch(error) {
                console.error('Render error:', error);
            } finally {
                isRendering = false;
                hideLoader();
            }
        };

        const updateUI = () => {
            document.getElementById('current-page').textContent = currentPage;
            document.getElementById('total-pages').textContent = pdfDoc?.numPages || 0;
            document.getElementById('prev-btn').disabled = currentPage === 1;
            document.getElementById('next-btn').disabled = currentPage === pdfDoc?.numPages;
        };

        // Touch handling
        let touchStartX = 0;
        let touchStartY = 0;

        const handleTouchStart = (e) => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        };

        const handleTouchEnd = (e) => {
            const deltaX = e.changedTouches[0].clientX - touchStartX;
            const deltaY = e.changedTouches[0].clientY - touchStartY;

            if(Math.abs(deltaX) > config.swipeThreshold && Math.abs(deltaX) > Math.abs(deltaY)) {
                if(deltaX > 0 && currentPage > 1) {
                    currentPage--;
                } else if(deltaX < 0 && currentPage < pdfDoc.numPages) {
                    currentPage++;
                }
                renderPage(currentPage);
            }
        };

        // Initialize
        const initPDFViewer = async () => {
            try {
                pdfDoc = await pdfjsLib.getDocument('IMG_8670_compressed.pdf').promise;
                pageCache = new Map([[1, await pdfDoc.getPage(1)]]);
                updateUI();
                renderPage(1);
                
                // Event listeners
                document.getElementById('prev-btn').addEventListener('click', () => {
                    if(currentPage > 1) renderPage(--currentPage);
                });

                document.getElementById('next-btn').addEventListener('click', () => {
                    if(currentPage < pdfDoc.numPages) renderPage(++currentPage);
                });

                document.addEventListener('touchstart', handleTouchStart);
                document.addEventListener('touchend', handleTouchEnd);
                document.addEventListener('keydown', (e) => {
                    if(e.key === 'ArrowLeft') document.getElementById('prev-btn').click();
                    if(e.key === 'ArrowRight') document.getElementById('next-btn').click();
                });

                window.addEventListener('resize', () => {
                    if(!isRendering) renderPage(currentPage);
                });

            } catch(error) {
                alert(`Lỗi tải catalogue: ${error.message}`);
            }
        };

        // Start application
        initPDFViewer();
    </script>
</body>
</html>
